name: "Run tests for PR"

on:
  pull_request:
    paths-ignore:
    - 'README.md'
    - 'changelog_config.json'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  dump-unicode-data:
    uses: ./.github/workflows/unicode-dump.yml
  collect-output-reviewdog:
    needs:
      - dump-unicode-data
    runs-on: ubuntu-latest
    steps:
    - name: 'Checkout Repository'
      uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version-file: .java-version
    - name: Validate Gradle Wrapper
      uses: gradle/actions/wrapper-validation@v4
    - name: Cache konan
      uses: actions/cache@v4
      with:
        path: ~/.konan
        key: ${{ runner.os }}-gradle-${{ hashFiles('*.gradle.kts') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    - name: Cache unicode data
      uses: actions/cache@v4
      with:
        enableCrossOsArchive: true
        fail-on-cache-miss: true
        path: unicode_dump
        key: unicode-dump-${{ hashFiles('unicode_dump/*') }}
        restore-keys: |
          unicode-dump-
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: wrapper
    - name: Run ktlint
      run: ./gradlew ktlintCheck --console plain > ktlint-reviewdog.out 2>&1 || true
    - name: Run detekt
      run: ./gradlew -q detekt detektAll --console plain > detekt-reviewdog.out 2>&1 || true
    - name: Collect output for reviewdog
      uses: actions/upload-artifact@v4
      with:
        name: style-reports
        path: '*-reviewdog.out'
  check-pr:
    needs:
      - dump-unicode-data
    uses: ./.github/workflows/build-and-test.yml
    with:
      collect-code-coverage: true
